\chapter{Algorithme de Barnes-Hut}

Pour accélérer les calculs et permettre de plus grandes simulations, nous allons dans cette partie s’intéresser à l’algorithme de Barnes-Hut.

\section{Présentation de l'algorithme}

L'algorithme de Barnes-Hut est algorithme hiérarchique inventé par Josh Barnes et Piet Hut en 1986. Il est basé sur l'utilisation d'un arbre appelé $quadtree$ afin d'approximer le calcul des  interactions gravitationnelles. Il permet de réduire les calculs de manière à obtenir une complexité en $O(Nlog(N))$, tout en restant physiquement correct. Sa fiabilité et son efficacité en fait alors l'algorithme le plus utilisé pour résoudre le problème à N corps.
 
\section{Principe général de l'algorithme}

L'idée est d'approcher les forces à longue portée en remplaçant un groupe de points éloignés par leur centre de masse. Il y a évidemment en contrepartie une légère part erreur et approximation mais ce schéma accélère considérablement le calcul. Notamment avec une complexité $ Nlog(N)$ plutôt que $N^2$.
Au centre de cette approximation se trouve un arbre : une « carte » de l'espace qui nous aide à modéliser des groupes de points comme un seul centre de masse. En deux dimensions, nous pouvons utiliser une structure de données quadtree, qui subdivise de manière récursive les régions carrées de l'espace en quatre quadrants de taille égale. (En trois dimensions, on peut utiliser un octree qui divise de la même manière un volume cubique en huit sous-cubes.)


\begin{center}
\includegraphics[scale=0.2]{./images/quadtree.png}
\captionsetup{hypcap=false}
\captionof{figure}{Exemple de Quadtree}
\label{fig4}
\end{center}

\section{L'algorithme de Barnes-Hut}
L'algorithme de Barnes Hut se décompose en trois majeurs parties:

\begin{enumerate}
\item la construction de l'arbre

\item le calcul des centres des masses et des masses correspondant à un nœud

\item le calcul des forces appliquées sur les particules
\end{enumerate}


Avant de détailler ces étapes nous avons besoin de mettre en place la notion de quadrants. Un quadrant est une division de notre arbre soit un nœud. Comme nous travaillons en deux dimensions, nous avons besoin de quatre quadrants, un quadrant en haut à gauche, un autre en bas à gauche , un troisième à droite en haute et un dernier à droite en bas. On les appellera respectivement NW,SW,NE et SE en référence aux points cardinaux.

\subsection{La construction de l'arbre}

Elle consiste aux insertions successives des particules dans l'arbre.

Soit la particule $p1$. Tout d'abord nous devons vérifier que $P1$ doit bien être insérée dans l'arbre.
Si c'est le cas nous distinguons plusieurs cas. 
\begin{itemize}

\item S'il existe plus d'une particule dans le nœud, on doit insérer la particule dans le fils du nœud auquel correspond sa position. S'il n'existe pas, on crée ce fils.


\item S'il existe qu'une seule particule dans le nœud, on réinsère l'ancienne particule dans le fils auquel correspond sa position puis on effectue l'insertion de $p1$ dans le quadrant qui lui correspond. Si les fils n'existent pas, on les crée avant l'insertion. 

\item Enfin s'il n'y a aucune particule dans le nœud, il s'agit  d'une feuille, on insère directement $p1$ sans créer de fils.

\end{itemize}

Il est important de noter que seule les feuilles contiennent des particules.

\subsection{Le calcul des masses et centres de masse}

Les calculs des masses et centres de masses se calculent naturellement de manière récursive en commençant par les feuilles de l'arbre.

Soit le nœud $n$. 
Si $n$ contient qu'une seule particule alors il s'agit d'une feuille et sa masse correspond à la masse de la particule et son centre de masse sera la position de la particule. Si ce n'est pas le cas, la masse de $n$ sera la somme des masses de chacun des fils et son centre du masse se calcule par la formule suivant

\begin{equation}
    CM_n = \frac{m_1*CM_1 + m_2*CM_2+ m_3*CM_3 + m_4*CM_4 }{\sum_{i=1}^{4}{m_i}}
\end{equation}

où $\forall i\in \{1,2,3,4\}$ $CM_i$ est le centre de masse d'un fils et $m_i$ est sa masse.

\subsection{Le calcul des forces}

L'avantage de l'utilisation d'un arbre est que le calcul des forces gravitationnelles se fait simplement de manière récursive pour chaque particule à partir de la racine de l'arbre.

Pour chaque particule $p$.

\begin{itemize}
\item Si le nœud actuel est une feuille, on calcule simplement la force exercée par la particule qu'elle contient sur la particule actuelle.

\item Sinon, on calcule le rapport $\frac{l}{D}$ où $l$ est la
longueur d'un coté du nœud actuel  et $D$ est la distance entre la particule $p$ et le centre de masse du nœud actuel.

On introduit alors le paramètre $\theta$ qu'on fixe autour de 1.
Si $\frac{l}{D} < \theta$ alors on calcule la force, appliquée à $p$ à partir du centre de masse et de la masse du nœud. Sinon, elle sera la somme des forces exercées par les fils de ce nœud.
\end{itemize}

Ce paramètre est important car il permet de régler le niveau de précision de l'algorithme et donc le nombre de calcul à effectuer.
Nous prendrons $\theta = 0.9$.


Nous avons ainsi le résultat suivant
\begin{center}
\includegraphics[scale=0.4]{./images/arbre_bh.png}
\captionsetup{hypcap=false}
\captionof{figure}{Arbre construit avec l'algorithme de Barnes Hut}
\label{fig5}
\end{center}

On peut donc déjà remarquer que physiquement le résultat obtenu semble correcte malgré les approximations effectuées, c'est ce qui fait la force de cet algorithme.
Il nous est alors possible de pousser les simulations plus loin pour simuler notamment la formation de galaxies (spirale ou sphériques) en augmentant considérablement le nombre de particules,. Cela montre alors l'intérêt et l'efficacité de l'algorithme de Barnes-Hut.

\begin{center}
\includegraphics[scale=0.9]{./images/spirale_2.png}
\captionsetup{hypcap=false}
\captionof{figure}{Galaxie spirale avec 30000 particules}
\label{fig5}
\end{center}